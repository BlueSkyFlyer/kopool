#= depend_on_asset "home.html"
#= depend_on_asset "nfl_teams/index.html"
#= depend_on_asset "nfl_teams/edit.html"
#= depend_on_asset "weeks/index.html"
#= depend_on_asset "matchups/index.html"

@kopool = angular.module("kopool", ["ngRoute", "ngResource", "ngCookies", "user", "navbar", "NflTeams", "Weeks", "Matchups"])
  .config(["$httpProvider", ($httpProvider) ->
    $httpProvider.defaults.headers.common["X-CSRF-Token"] = $("meta[name=csrf-token]").attr("content")
    interceptor = ["$location", "$rootScope", "$q", ($location, $rootScope, $q) ->
      success = (response) ->
        console.log("Successful interceptor")
        response

      error = (response) ->
        console.log("Error interceptor")
        if response.status is 401
          console.log("(main) UNAUTHORIZED")
          $rootScope.$broadcast "event:unauthorized"
          $location.path "/users/sign_in"
          return response
        $q.reject response

      (promise) ->
        promise.then success, error
    ]
    $httpProvider.responseInterceptors.push(interceptor);
])


@kopool.config(['$routeProvider', ($routeProvider) ->

  console.log("routeprovider: " + $routeProvider)

  $routeProvider.
    when('/nfl_teams', {
      templateUrl: '<%= asset_path("nfl_teams/index.html") %>',
      controller: 'NflTeamsCtrl'
    }).
    when('/nfl_teams/:id', {
      templateUrl: '<%= asset_path("nfl_teams/edit.html") %>',
      controller: 'NflTeamsCtrl'
    }).
    when('/weeks/:week_id/matchups', {
      templateUrl:'<%= asset_path("matchups/index.html") %>',
      controller: 'MatchupsCtrl'
    }).
    when('/weeks', {
      templateUrl: '<%= asset_path("weeks/index.html") %>',
      controller: 'WeeksCtrl'
    }).
    when('/seasons/:season_id/weeks', {
      templateUrl: '<%= asset_path("weeks/index.html") %>',
      controller: 'WeeksCtrl'
    }).
    when('/users/login', {
      templateUrl:'/users/login.html',
      controller: 'UsersCtrl'
    }).
    when('/users/register', {
      templateUrl:'/users/register.html',
      controller: 'UsersCtrl'
    }).
    otherwise({
      templateUrl: '<%= asset_path("home.html") %>'
      controller: 'HomeCtrl'
    })

])


@kopool.run( ($rootScope, $location, AuthService) ->
  $rootScope.$on('$routeChangeStart', (event, next, current) ->
    console.log("===========> routeChangeStart <===============")
    console.log("next.templateUrl = " + next.templateUrl)
    unless AuthService.isAuthenticated() or next.templateUrl is 'tmpl/login.tmpl.html'
      $location.url '/login'
    )
  )


